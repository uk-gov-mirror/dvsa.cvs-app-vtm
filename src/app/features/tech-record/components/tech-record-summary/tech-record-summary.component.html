<section class="govuk-grid-row">
  <div [id]="'required-fields-hint'" class="govuk-hint">Complete all required fields to create a testable record</div>
  <app-accordion-control [class]="'padding'" [sectionState]="sectionTemplatesState$ | async">
    <div class="govuk-grid-column-one-half">
      @for (section of sectionTemplates; track section; let i = $index) {
        @if (i < middleIndex) {
          <app-accordion
            [id]="section.name"
            [title]="section.label"
            [isExpanded]="isSectionExpanded$(section.name) | async">
            <ng-template [ngTemplateOutlet]="accordion"
            [ngTemplateOutletContext]="{ sectionName: section.name, section: section }"></ng-template>
          </app-accordion>
        }
      }
    </div>
    <div class="govuk-grid-column-one-half">
      @for (section of sectionTemplates; track section; let i = $index) {
        @if (i >= middleIndex) {
          <app-accordion
            [id]="section.name"
            [title]="section.label"
            [isExpanded]="isSectionExpanded$(section.name) | async">
            <ng-template [ngTemplateOutlet]="accordion"
            [ngTemplateOutletContext]="{ sectionName: section.name, section: section }"></ng-template>
          </app-accordion>
        }
      }
    </div>
  </app-accordion-control>
</section>

<ng-template #accordion let-sectionName="sectionName" let-section="section">
  <form [formGroup]="form">
    @if (techRecordCalculated) {
      @switch (sectionName) {
        @case ('notesSection') {
          <app-notes-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
        }
        @case ('auditSection') {
          <app-audit-section [techRecord]="techRecordCalculated" [mode]="'view'"/>
        }
        @case ('techRecordSummary') {
          <app-vehicle-section [isCreateMode]="isCreateMode()" [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
        }
        @case ('bodySection') {
          <app-body-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
        }
        @case ('purchaserSection') {
          @if (techRecordCalculated.techRecord_vehicleType === 'trl') {
            <!-- New Purchaser section -->
            @if (featureToggleService.isFeatureEnabled('fspurchasers')) {
              <app-trl-purchasers-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
            } @else {
              <app-dynamic-form-group
                [data]="techRecordCalculated"
                [template]="section"
                [edit]="(isEditing$ | async) ?? false"
                (formChange)="handleFormState($event)"
              ></app-dynamic-form-group>
            }
            <!-- Old Purchaser section -->
          }
        }
        @case ('dimensionsSection') {
          @if (
            techRecordCalculated.techRecord_vehicleType === 'trl' ||
            techRecordCalculated.techRecord_vehicleType === 'hgv' ||
            techRecordCalculated.techRecord_vehicleType === 'psv'
            ) {
            <!-- Dimensions section-->
            <app-dimensions-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"></app-dimensions-section>
          }
        }
        @case ('documentsSection') {
          @if (
            techRecordCalculated.techRecord_vehicleType === 'trl' ||
            techRecordCalculated.techRecord_vehicleType === 'hgv' ||
            techRecordCalculated.techRecord_vehicleType === 'psv'
            ) {
            <app-documents-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"></app-documents-section>
          }
        }
        @case ('approvalSection') {
          <!-- New Type Approval section -->
          @if (featureToggleService.isFeatureEnabled('fsapprovaltype')) {
            @if (techRecordCalculated.techRecord_vehicleType === 'trl' ||
              techRecordCalculated.techRecord_vehicleType === 'hgv' ||
              techRecordCalculated.techRecord_vehicleType === 'psv') {
              <app-type-approval-section
                [techRecord]="techRecordCalculated"
                [mode]="(isEditing$ | async) ? 'edit' : 'view'">
              </app-type-approval-section>
            }
          } @else {
            @if (
              techRecordCalculated.techRecord_vehicleType === 'trl' ||
              techRecordCalculated.techRecord_vehicleType === 'hgv' ||
              techRecordCalculated.techRecord_vehicleType === 'psv'
              ) {
              <app-approval-type
                [techRecord]="techRecordCalculated"
                [isEditing]="(isEditing$ | async) ?? false"
                (formChange)="handleFormState($event)"
              ></app-approval-type>
            }
          }
          <!-- Old Type Approval section -->
        }
        @case ('brakesSection'){
          @if (techRecordCalculated.techRecord_vehicleType === 'trl' ||techRecordCalculated.techRecord_vehicleType === 'psv') {
            <app-brakes-section
              [techRecord]="techRecordCalculated"
              [mode]="(isEditing$ | async) ? 'edit' : 'view'"
              (formChange)="handleFormState($event)"
            ></app-brakes-section>
          }
        }

        @case('dda') {
          @if (techRecordCalculated.techRecord_vehicleType === 'psv') {
            <!-- New Tyres section -->
            <app-dda-section
              [techRecord]="techRecordCalculated"
              [mode]="(isEditing$ | async) ? 'edit' : 'view'"
            ></app-dda-section>
          }
        }
        @case ('tyreSection') {
          @if (
            techRecordCalculated.techRecord_vehicleType === 'trl' ||
            techRecordCalculated.techRecord_vehicleType === 'hgv' ||
            techRecordCalculated.techRecord_vehicleType === 'psv'
            ) {
            <app-tyres-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'" />
          }
        }
        @case ('weightsSection') {
          @if (
            techRecordCalculated.techRecord_vehicleType === 'trl' ||
            techRecordCalculated.techRecord_vehicleType === 'hgv' ||
            techRecordCalculated.techRecord_vehicleType === 'psv'
            ) {
            <app-weights-section
              [techRecord]="techRecordCalculated"
              [mode]="(isEditing$ | async) ? 'edit' : 'view'"
            ></app-weights-section>
          }
        }
        @case ('lettersSection') {
          @if (techRecordCalculated.techRecord_vehicleType === 'trl') {
            <app-letters-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
          }
        }
        @case ('platesSection') {
          @if (techRecordCalculated.techRecord_vehicleType === 'hgv' || techRecordCalculated.techRecord_vehicleType === 'trl') {
            <!-- New Plates Section -->
            <app-plates-section
                [techRecord]="techRecordCalculated"
                [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
          }
        }

        @case ('authorizationIntoServiceSection') {
          @if (techRecordCalculated.techRecord_vehicleType === 'trl') {
            <!-- New Authorization into service section -->
            <app-authorisation-into-service-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'" />
          }
        }

        @case('manufacturerSection') {
          @if (techRecordCalculated.techRecord_vehicleType === 'trl') {
            <!-- New manufacturer section -->
            <app-manufacturer-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
          }
        }

        @case ('adrSection') {
          @if (
            techRecordCalculated.techRecord_vehicleType === 'hgv' ||
            techRecordCalculated.techRecord_vehicleType === 'trl' ||
            techRecordCalculated.techRecord_vehicleType === 'lgv'
            ) {
              <app-adr-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
          }
        }
        @case ('adrCertificateSection') {
          @if (
            techRecordCalculated.techRecord_vehicleType === 'hgv' ||
            techRecordCalculated.techRecord_vehicleType === 'trl' ||
            techRecordCalculated.techRecord_vehicleType === 'lgv'
            ) {
            <app-adr-certs-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'" />
          }
        }
        @case ('techRecord') {
          <!-- New Last Applicant section -->
          <app-last-applicant-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'" />
        }
        @case ('reasonForCreationSection') {
          @if (featureToggleService.isFeatureEnabled('fsreasonforcreation')) {
            <app-reason-for-creation-section
              [techRecord]="techRecordCalculated"
              [mode]="(isEditing$ | async) ? 'edit' : 'view'"
            ></app-reason-for-creation-section>
          } @else {
            <app-dynamic-form-group
              [data]="techRecordCalculated"
              [template]="section"
              [edit]="(isEditing$ | async) ?? false"
              (formChange)="handleFormState($event)"
            ></app-dynamic-form-group>
          }
        }
        @default {
          <app-dynamic-form-group
            [data]="techRecordCalculated"
            [template]="section"
            [edit]="(isEditing$ | async) ?? false"
            (formChange)="handleFormState($event)"
          ></app-dynamic-form-group>
        }
      }
    }
  </form>
</ng-template>
