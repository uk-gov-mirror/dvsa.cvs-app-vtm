<section class="govuk-grid-row">
  <div [id]="'required-fields-hint'" class="govuk-hint">Complete all required fields to create a testable record</div>
  <app-accordion-control [class]="'padding'" [sectionState]="sectionTemplatesState$ | async">
    <div class="govuk-grid-column-one-half">
      <ng-container *ngFor="let section of sectionTemplates; let i = index">
        <app-accordion *ngIf="i < middleIndex" [id]="section.name" [title]="section.label"
                       [isExpanded]="isSectionExpanded$(section.name) | async">
          <ng-template [ngTemplateOutlet]="accordion"
                       [ngTemplateOutletContext]="{ sectionName: section.name, section: section }"></ng-template>
        </app-accordion>
      </ng-container>
    </div>
    <div class="govuk-grid-column-one-half">
      <ng-container *ngFor="let section of sectionTemplates; let i = index">
        <app-accordion *ngIf="i >= middleIndex" [id]="section.name" [title]="section.label" [isExpanded]="isSectionExpanded$(section.name) | async">
          <ng-template [ngTemplateOutlet]="accordion"
                       [ngTemplateOutletContext]="{ sectionName: section.name, section: section }"></ng-template>
        </app-accordion>
      </ng-container>
    </div>
  </app-accordion-control>
</section>

<ng-template #accordion let-sectionName="sectionName" let-section="section">
  <form [formGroup]="form">
    <ng-container *ngIf="techRecordCalculated">
      <ng-container [ngSwitch]="sectionName">
        <ng-container *ngSwitchCase="'notesSection'">
          <!-- New Notes section -->
          <ng-container *ngIf="featureToggleService.isFeatureEnabled('FsNotes'); else oldNotes">
            <app-notes-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
          </ng-container>

          <!-- Old Notes section -->
          <ng-template #oldNotes>
            <app-dynamic-form-group
              [data]="techRecordCalculated"
              [template]="section"
              [edit]="(isEditing$ | async) ?? false"
              (formChange)="handleFormState($event)"
            ></app-dynamic-form-group>
          </ng-template>
        </ng-container>

        <ng-container *ngSwitchCase="'techRecordSummary'">
          <!-- New Vehicle summary section -->
          <ng-container *ngIf="featureToggleService.isFeatureEnabled('FsVehicleSummary'); else oldTechRecordSummary">
            <app-vehicle-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
          </ng-container>

          <!-- Old Vehicle summary section -->
          <ng-template #oldTechRecordSummary>
            <app-dynamic-form-group
              [data]="techRecordCalculated"
              [template]="section"
              [edit]="(isEditing$ | async) ?? false"
              (formChange)="handleFormState($event)"
            ></app-dynamic-form-group>
          </ng-template>

        </ng-container>

        <ng-container *ngSwitchCase="'bodySection'">
          <!-- New Body section -->
          <ng-container *ngIf="featureToggleService.isFeatureEnabled('FsBody'); else oldBodySection">
            <app-body-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
          </ng-container>

          <!-- Old Body section -->
          <ng-template #oldBodySection>
            <app-body
              [techRecord]="techRecordCalculated"
              [isEditing]="(isEditing$ | async) ?? false"
              (formChange)="handleFormState($event)"
            ></app-body>
          </ng-template>
        </ng-container>

        <ng-container *ngSwitchCase="'purchaserSection'">
          <ng-container *ngIf="techRecordCalculated.techRecord_vehicleType === 'trl'">
            <!-- New Purchaser section -->
            <ng-container *ngIf="featureToggleService.isFeatureEnabled('FsPurchasers'); else oldPurchaserSection">
              <app-trl-purchasers-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
            </ng-container>

            <!-- Old Purchaser section -->
            <ng-template #oldPurchaserSection>
              <app-dynamic-form-group
                [data]="techRecordCalculated"
                [template]="section"
                [edit]="(isEditing$ | async) ?? false"
                (formChange)="handleFormState($event)"
              ></app-dynamic-form-group>
            </ng-template>
          </ng-container>
        </ng-container>

        <ng-container *ngSwitchCase="'dimensionsSection'">
          <ng-container *ngIf="
            techRecordCalculated.techRecord_vehicleType === 'trl' ||
            techRecordCalculated.techRecord_vehicleType === 'hgv' ||
            techRecordCalculated.techRecord_vehicleType === 'psv'
          ">
            <!-- New dimensions section-->
            <ng-container *ngIf="featureToggleService.isFeatureEnabled('FsDimensions'); else oldDimensionsSection">
              <app-dimensions-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"></app-dimensions-section>
            </ng-container>

            <!-- Old dimensions section-->
            <ng-template #oldDimensionsSection>
              <app-dimensions
                [techRecord]="techRecordCalculated"
                [isEditing]="(isEditing$ | async) ?? false"
                (formChange)="handleFormState($event)"
              ></app-dimensions>
            </ng-template>
          </ng-container>
        </ng-container>

        <ng-container *ngSwitchCase="'approvalSection'">
          <!-- New Type Approval section -->
          <ng-container *ngIf="featureToggleService.isFeatureEnabled('FsApprovalType'); else oldApprovalType;">
            <app-type-approval-section
              *ngIf="techRecordCalculated.techRecord_vehicleType === 'trl' ||
              techRecordCalculated.techRecord_vehicleType === 'hgv' ||
              techRecordCalculated.techRecord_vehicleType === 'psv'"
              [techRecord]="techRecordCalculated"
              [mode]="(isEditing$ | async) ? 'edit' : 'view'">
            </app-type-approval-section>
          </ng-container>

          <!-- Old Type Approval section -->
          <ng-template #oldApprovalType>
            <app-approval-type
              *ngIf="
              techRecordCalculated.techRecord_vehicleType === 'trl' ||
              techRecordCalculated.techRecord_vehicleType === 'hgv' ||
              techRecordCalculated.techRecord_vehicleType === 'psv'
            "
              [techRecord]="techRecordCalculated"
              [isEditing]="(isEditing$ | async) ?? false"
              (formChange)="handleFormState($event)"
            ></app-approval-type>
          </ng-template>
        </ng-container>

        <ng-container *ngSwitchCase="'psvBrakesSection'">
          <app-psv-brakes
            *ngIf="techRecordCalculated.techRecord_vehicleType === 'psv'"
            [vehicleTechRecord]="techRecordCalculated"
            [isEditing]="(isEditing$ | async) ?? false"
            (formChange)="handleFormState($event)"
          ></app-psv-brakes>
        </ng-container>

        <ng-container *ngSwitchCase="'trlBrakesSection'">
          <app-trl-brakes
            *ngIf="techRecordCalculated.techRecord_vehicleType === 'trl'"
            [vehicleTechRecord]="techRecordCalculated"
            [isEditing]="(isEditing$ | async) ?? false"
            (formChange)="handleFormState($event)"
          ></app-trl-brakes>
        </ng-container>

        <ng-container *ngSwitchCase="'tyreSection'">
          <ng-container *ngIf="
            techRecordCalculated.techRecord_vehicleType === 'trl' ||
            techRecordCalculated.techRecord_vehicleType === 'hgv' ||
            techRecordCalculated.techRecord_vehicleType === 'psv'
          ">
            <!-- New Tyres section -->
            <ng-container *ngIf="featureToggleService.isFeatureEnabled('FsTyres'); else oldTyresSection">
              <app-tyres-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'" />
            </ng-container>

            <!-- Old Tyres section -->
            <ng-template #oldTyresSection>
              <app-tyres
                [vehicleTechRecord]="techRecordCalculated"
                [isEditing]="(isEditing$ | async) ?? false"
                (formChange)="handleFormState($event)"
              ></app-tyres>
            </ng-template>
          </ng-container>
        </ng-container>

        <ng-container *ngSwitchCase="'weightsSection'">
          <ng-container *ngIf="
              techRecordCalculated.techRecord_vehicleType === 'trl' ||
              techRecordCalculated.techRecord_vehicleType === 'hgv' ||
              techRecordCalculated.techRecord_vehicleType === 'psv'
            ">
            <!-- New Weights Section -->
            <ng-container *ngIf="featureToggleService.isFeatureEnabled('FsWeights'); else oldWeightsSection">
              <app-weights-section
                [techRecord]="techRecordCalculated"
                [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
            </ng-container>
            <!-- Old Weights Section -->
            <ng-template #oldWeightsSection>
              <app-weights
                [vehicleTechRecord]="techRecordCalculated"
                [isEditing]="(isEditing$ | async) ?? false"
                (formChange)="handleFormState($event)"
              ></app-weights>
            </ng-template>
          </ng-container>
        </ng-container>

        <ng-container *ngSwitchCase="'lettersSection'">
          <app-letters
            *ngIf="techRecordCalculated.techRecord_vehicleType === 'trl'"
            [techRecord]="techRecordCalculated"
            [isEditing]="(isEditing$ | async) ?? false"
            (formChange)="handleFormState($event)"
          ></app-letters>
        </ng-container>

        <ng-container *ngSwitchCase="'platesSection'">
          <ng-container *ngIf="techRecordCalculated.techRecord_vehicleType === 'hgv' || techRecordCalculated.techRecord_vehicleType === 'trl'">
            <!-- New Plates Section -->
            <ng-container *ngIf="featureToggleService.isFeatureEnabled('FsPlates'); else oldPlatesSection">
              <app-plates-section
                [techRecord]="techRecordCalculated"
                [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
            </ng-container>
            <!-- Old Plates Section -->
            <ng-template #oldPlatesSection>
              <app-plates
                *ngIf="techRecordCalculated.techRecord_vehicleType === 'hgv' || techRecordCalculated.techRecord_vehicleType === 'trl'"
                [techRecord]="techRecordCalculated"
                [isEditing]="(isEditing$ | async) ?? false"
                (formChange)="handleFormState($event)"
              ></app-plates>
            </ng-template>
          </ng-container>
        </ng-container>

        <ng-container *ngSwitchCase="'adrSection'">
          <ng-container
            *ngIf="
              techRecordCalculated.techRecord_vehicleType === 'hgv' ||
              techRecordCalculated.techRecord_vehicleType === 'trl' ||
              techRecordCalculated.techRecord_vehicleType === 'lgv'
            "
          >
            <!-- New ADR section -->
            <ng-container *ngIf="featureToggleService.isFeatureEnabled('FsAdr'); else oldADRSection">
              <app-adr-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'"/>
            </ng-container>

            <!-- Old ADR section -->
            <ng-template #oldADRSection>
              <app-adr [techRecord]="techRecordCalculated" [isEditing]="(isEditing$ | async) ?? false"/>
            </ng-template>
          </ng-container>
        </ng-container>

        <ng-container *ngSwitchCase="'adrCertificateSection'">
          <ng-container
            *ngIf="
              techRecordCalculated.techRecord_vehicleType === 'hgv' ||
              techRecordCalculated.techRecord_vehicleType === 'trl' ||
              techRecordCalculated.techRecord_vehicleType === 'lgv'
            "
          >
            <app-adr-certificate-history [currentTechRecord]="techRecordCalculated"></app-adr-certificate-history>
          </ng-container>
        </ng-container>


        <ng-container *ngSwitchCase="'techRecord'">
          <!-- New Last Applicant section -->
          <ng-container *ngIf="featureToggleService.isFeatureEnabled('FsLastApplicant'); else oldLastApplicantComponent">
            <app-last-applicant-section [techRecord]="techRecordCalculated" [mode]="(isEditing$ | async) ? 'edit' : 'view'" />
          </ng-container>

          <!-- Old Last Applicant section -->
          <ng-template #oldLastApplicantComponent>
            <app-dynamic-form-group
              [data]="techRecordCalculated"
              [template]="section"
              [edit]="(isEditing$ | async) ?? false"
              (formChange)="handleFormState($event)"
            ></app-dynamic-form-group>
          </ng-template>
        </ng-container>

        <app-dynamic-form-group
          *ngSwitchDefault
          [data]="techRecordCalculated"
          [template]="section"
          [edit]="(isEditing$ | async) ?? false"
          (formChange)="handleFormState($event)"
        ></app-dynamic-form-group>
      </ng-container>
    </ng-container>
  </form>
</ng-template>
